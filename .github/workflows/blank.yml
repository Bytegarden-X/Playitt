name: Playit RDP Tunnel (macOS)

on:
  workflow_dispatch:

jobs:
  setup-rdp-tunnel:
    runs-on: macos-13  # Bisa ganti ke macos-14 atau macos-latest untuk Sonoma

    steps:
    - name: Check out the repository
      uses: actions/checkout@v4  # Menggunakan versi terbaru untuk keamanan

    - name: Install Homebrew and xrdp
      run: |
        # Instal Homebrew
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        # Tambahkan Homebrew ke PATH
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
        eval "$(/opt/homebrew/bin/brew shellenv)"
        # Instal xrdp dan XQuartz (diperlukan untuk display server)
        brew install xrdp
        brew install --cask xquartz
        # Jalankan XQuartz
        open -a XQuartz &

    - name: Download and Install Playit
      run: |
        curl -L -o ~/playit https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-macos-universal
        chmod +x ~/playit
        sleep 5  # Jeda untuk memastikan download selesai

    - name: Configure xrdp
      run: |
        # Jalankan xrdp dan xrdp-sesman
        sudo xrdp
        sudo xrdp-sesman
        # Set password untuk user 'admin' dari GitHub Secrets
        echo "admin:${{ secrets.RUNNER_PASSWORD }}" | sudo chpasswd
        # Buka port 3389 di firewall
        sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /opt/homebrew/bin/xrdp
        sudo /usr/libexec/ApplicationFirewall/socketfilterfw --unblockapp /opt/homebrew/bin/xrdp

    - name: Optimize macOS for RDP
      run: |
        # Nonaktifkan layanan yang tidak perlu
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.metadata.mds.plist  # Spotlight
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.xpc.launchd.oneshot.plist  # Background tasks
        # Set energi ke performa tinggi
        sudo pmset -a lowpowermode 0
        sudo pmset -a displaysleep 0
        # Nonaktifkan efek visual
        defaults write -g NSAutomaticWindowAnimationsEnabled -bool2
        # Optimasi jaringan
        sudo sysctl -w net.inet.tcp.msl=30000

    - name: Start Playit and Set Up RDP Tunnel
      env:
        PLAYIT_AUTH_KEY: ${{ secrets.PL }}
      run: |
        # Jalankan Playit untuk tunnel port 3389
        nohup ~/playit --secret $PLAYIT_AUTH_KEY --tunnel add tcp remote-port 3389 local-addr 127.0.0.1:3389 &
        sleep 10  # Tunggu tunnel aktif

    - name: Keep the GitHub Action Runner Alive
      run: sleep 21600  # 6 jam untuk menjaga runner aktif
